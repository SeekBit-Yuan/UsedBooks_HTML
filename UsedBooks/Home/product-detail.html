<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>product-detail</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/own.css" />
		<style type="text/css">
			.mui-table-view-cell {
				list-style: none;
			}
			
			.mui-table-view-cell:after {
				left: 0px;
			}
			
			.mui-table-view .mui-table-view-cell {
				background-color: white;
			}
			
			.mui-slider-indicator .mui-active.mui-indicator {
				/*background-color: #41CEA9;*/
			}
			
			#headul:after {
				height: 0px;
			}
			
			#headul .mui-table-view-cell {
				padding-bottom: 0px;
				padding-top: 0px;
				margin-top: 0px;
				background-color: white;
			}
			
			#headul {
				margin-top: 10px;
				margin-bottom: 8px;
			}
			
			#headul .mui-table-view-cell:after {
				height: 0px;
			}
			
			.mui-table-cell .borderleft {
				height: 40%;
				border-left: 1px solid gray;
				margin-left: 5px;
			}
			
			.mui-icon.iconfont {
				font-size: 1em;
				color: #41CEA9;
			}
			
			#headul .mui-table-view-cell.setbg {
				background-color: #f3fcfb;
			}
			
			#headul .mui-table-view-cell.setbg div {
				font-size: 0.7em;
				color: gray;
			}
			
			.mui-table-view-cell p.evaluateTitle {
				color: black;
				font-size: 1em;
			}
			
			.mui-table-view {
				margin-bottom: 10px;
			}
			
			span.evaluate {
				font-size: 0.68em;
				color: darkgray;
				border: 1px solid darkgray;
				word-break: nowrap;
				word-wrap: nowrap;
				border-radius: 2px;
				text-align: center;
			}
			
			.mui-table-view-cell .evaluaterHead img {
				background-color: darkgray;
				width: 2.5em;
				max-width: 2.5em;
				height: 2.5em;
				border: 1px solid gray;
				border-radius: 50%;
			}
			
			.mui-table-view-cell .evaluaterHead span {
				font-size: 0.9em;
				vertical-align: super;
			}
			
			.mui-table-view-cell .evaluteContent {
				font-size: 0.7em;
				line-height: 1.2em;
			}
			
			.mui-table-view-cell .evaluteMsg {
				font-size: 0.5em;
			}
			
			.mui-table-view-cell.moreEvaluate {
				text-align: center;
				padding-top: 8px;
				padding-bottom: 8px;
			}
			
			.mui-table-view-cell.moreEvaluate a {
				color: darkgray;
			}
			
			.mui-table .mui-col-xs-4 {
				font-size: 0.68em;
				color: darkgray;
			}
			
			.mui-table .mui-col-xs-6 {
				line-height: 1.1em;
				font-size: 0.8em;
			}
			
			.mui-table .mui-col-xs-6 .stroemsg {
				font-size: 0.5em;
				color: darkgray;
			}
			
			.mui-table .mui-col-xs-6 .lingBtn {
				font-size: 1em;
			}
			
			.mui-table-view.mui-grid-view .mui-table-view-cell .mui-media-body {
				margin-top: 2px;
				margin-bottom: 5px;
				height: auto;
			}
			
			.mui-table-view.mui-grid-view .mui-table-view-cell .mui-media-body p.mui-ellipsis-2 {
				font-size: 0.5em;
				line-height: 1.2em;
				white-space: pre;
				height: 2.3em;
			}
			
			.mui-table-view.mui-grid-view .mui-table-view-cell .mui-media-body p.price {
				font-size: 0.8em;
				color: #41CEA9;
			}
		</style>
	</head>

	<body>

		<header class="mui-action-back mui-bar mui-bar-nav own-main-background-color">
			<button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>
				<span class="own-left-nav-color">主页</span>
			</button>
			<h1 class="mui-title" style="font-weight: bold;">图书详情</h1>
		</header>
		<div class="mui-content">
			<li class="mui-table-view-cell" style="padding-bottom: 5px;">
				<div class="mui-table">
					<img id="trueimg" src="../img/ic_book1.jpg" style="background:blue;width:80%;height:80%;" />
				</div>
			</li>
			<li class="mui-table-view-cell">
				<div class="mui-table">
					<div class="mui-table-cell mui-col-xs-10" style="width: 50%;">
						<h5 id="bname" class="own-black-color mui-ellipsis-2" style="height: 30px;line-height: 30px;font-size: 20px;"></h5>
						<h6 id="author" class="own-text" style="font-size: 15px;"></h6>
						<h6 id="publish" class="own-text" style="font-size: 15px;"></h6>
						<h5 id="cur_price" class="own-main-color" style="font-size: 18px;"></h5>
						<h6 id="price" class="own-text-through" style="font-size: 15px;"></h6>
					</div>
					<div class="mui-table-cell mui-col-xs-2 mui-text-right" style="width: 50%;">
						<div class="borderleft">
							<h6 id="bdesc" class="own-text" style="font-size: 12px;"></h6>
						</div>
					</div>
			</li>
			<li class="mui-table-view-cell">
				<div class="evaluaterHead">
					<img src="../img/3.jpg">
					<span id="nickname" class="mui-ellipsis"></span>
				</div>
				<div class="mui-table">
					<div id="phone" class="mui-table-cell mui-col-xs-4"></div>
					<div id="address" class="mui-table-cell mui-col-xs-4"></div>
				</div>
			</li>
			</li>
			<li class="mui-table-view-cell moreEvaluate" style="padding-bottom: 80px;">
				<a></a>
			</li>

			<nav class="mui-bar mui-bar-tab ">
				<a id="chat" class="mui-tab-item mui-active" style="width: 14%;">
					<span class="mui-icon iconfont icon-lianxi" style="font-size: 24px;color: gray;"></span>
					<span class="mui-tab-label" style="font-size: 12px;color: gray;">卖家</span>
				</a>
				<a id="collection" class="mui-tab-item" style="width: 14%;">
					<span id="collection_icon" class="mui-icon iconfont icon-biaoxing" style="font-size: 24px;color: gray;"></span>
					<span id="collection_text" class="mui-tab-label" style="font-size: 12px;color: gray;">收藏</span>
				</a>
				<a id="cart" class="mui-tab-item" href="barItem/cart.html" style="width: 16%;">
					<span class="mui-icon iconfont icon-gouwuche" style="font-size: 24px;color: gray;"><span id="cartNum" class="mui-badge">0</span></span>
					<span class="mui-tab-label" style="font-size: 12px;color: gray;">购物车</span>
				</a>
				<a id="addCart" class="mui-tab-item" style="width:28%;background-color:orange;">
					<span class="mui-tab-label" style="font-size: 17px;color: white;">加入购物车</span>
				</a>
				<a id="buy" class="mui-tab-item" style="width:28%;background-color:red">
					<span class="mui-tab-label" style="font-size: 18px;color: white;">立即购买</span>
				</a>
			</nav>
			</div>

			<script src="../js/av.js"></script>
			<script src="../js/av-min.js"></script>
			<script type="text/javascript" src="../js/mui.min.js"></script>
			<script type="text/javascript" src="../js/own.js"></script>
			<script src="../js/jquery-3.1.1.min.js"></script>
			<script type="text/javascript" charset="UTF-8">
				var APP_ID = 'buGABhqtimg7HSEsEzvamc0Q-gzGzoHsz';
				var APP_KEY = 'RLnd5XpcckbBrJDtXQdXSUBs';
				AV.init({
					appId: APP_ID,
					appKey: APP_KEY,
				});

				mui.init({
					swipeBack: false
				});

				mui.plusReady(function() {
					//初始化图书详情界面
					setBookDetail();

					//初始化评论详情
					//					setComment();

					//初始化导航栏
					setBar();

				})

				function setBookDetail() {
					var bid = 3;
					var Book = AV.Object.extend('Book');
					var query = new AV.Query(Book);
					query.equalTo("bid", bid);
					query.first().then(function(results) {
						query.get(results.id).then(function(Book) {
							bname = document.getElementById("bname").innerText = Book.get("bname");
							author = document.getElementById("author").innerText = Book.get("author");
							publish = document.getElementById("publish").innerText = Book.get("publish");
							cur_price = document.getElementById("cur_price").innerText = Book.get("cur_price");
							price = document.getElementById("price").innerText = Book.get("price");
							bdesc = document.getElementById("bdesc").innerText = Book.get("bdesc");
							var oid = Book.get("oid");

							var query = new AV.Query('_User');
							query.get(oid).then(function(todo) {
								nickname = document.getElementById("nickname").innerText = todo.get("nickname");
								phone = document.getElementById("phone").innerText = todo.get("mobilePhoneNumber");
								address = document.getElementById("address").innerText = todo.get("address");
							}, function(error) {
								alert("卖家详情获取失败！");
							    return;
							});
							return;
						}, function(error) {
							alert("图书详情获取失败！");
							return;
						});
					}, function(error) {
						alert("图书查找失败！");
						return;
					});

				}

				function setBar() {
					account = localStorage.getItem('user');
					password = localStorage.getItem('password');

					AV.User.logIn(account, password).then(function(loginedUser) {
						var bid = 3;
						var uid = loginedUser.get("uid");

						var Collection = AV.Object.extend('Collection');
						var query1 = new AV.Query(Collection);
						query1.equalTo("bid", bid);
						var query2 = new AV.Query(Collection);
						query2.equalTo("uid", uid);
						var query3 = AV.Query.and(query1, query2);
						query3.count().then(function(count) {
							if(count > 0) {
								collection_icon = document.getElementById("collection_icon");
								collection_icon.style.color = "#41CEA9";
								collection_text = document.getElementById("collection_text").innerText = "已收藏";
							} else if(count == 0) {
								collection_text = document.getElementById("collection_text").innerText = "收藏";
							}

						});

						var Cart = AV.Object.extend('Cart');
						var query = new AV.Query(Cart);
						query.equalTo("uid", uid);
						query.count().then(function(count) {
							cratNum = document.getElementById("cartNum").innerText = count;
						}, function(error) {
							cratNum = document.getElementById("cartNum").innerText = 0;
						});
					});

					addCart.addEventListener('tap', function() {
						if(localStorage.getItem('user')) {
							var account = localStorage.getItem('user');
							var password = localStorage.getItem('password');

							AV.User.logIn(account, password).then(function(loginedUser) {
								var uid = loginedUser.get("uid");
								var bid = 3;
								var date = new Date();
								var Cart = AV.Object.extend('Cart');
								var cart = new Cart();
								cart.set("uid", uid);
								cart.set("bid", bid);
								cart.set("num", 1);
								cart.set("date", date);
								cart.save().then(function(cart) {
									var Cart = AV.Object.extend('Cart');
									var query = new AV.Query(Cart);
									query.equalTo("uid", uid);
									query.count().then(function(count) {
										cratNum = document.getElementById("cartNum").innerText = count;
									}, function(error) {
										alert("更新购物车失败！");
									});
								}, function(error) {
									alert("加入购物车失败！");
									return;
								});

							});
						} else {
							alert("请先登录！");
							mui.openWindow({
								id: "mine/login.html",
								url: "../mine/login.html"
							});
						}

					}, false);

					cart.addEventListener("tap", function() {
						if(localStorage.getItem('user')) {
							mui.openWindow({
								id: "Home/mycart.html",
								url: "../Home/mycart.html"
							});
						} else {
							alert("请先登录！");
							mui.openWindow({
								id: "mine/login.html",
								url: "../mine/login.html"
							});
						}
					});

					collection.addEventListener("tap", function() {
						if(localStorage.getItem('user')) {
							var account = localStorage.getItem('user');
							var password = localStorage.getItem('password');

							if(collection_text == "已收藏") {
								alert("你已收藏该书！")
							} else {
								AV.User.logIn(account, password).then(function(loginedUser) {
									var uid = loginedUser.get("uid");
									var bid = 3;
									var date = new Date();
									var Collection = AV.Object.extend('Collection');
									var collection = new Collection();
									collection.set("uid", uid);
									collection.set("bid", bid);
									collection.set("date", date);
									collection.save().then(function(collection) {
										collection_icon = document.getElementById("collection_icon");
										collection_icon.style.color = "#41CEA9";
										collection_text = document.getElementById("collection_text").innerText = "已收藏";
									}, function(error) {
										alert("添加收藏夹失败！");
										return;
									});
								});
							}

						} else {
							alert("请先登录！");
							mui.openWindow({
								id: "mine/login.html",
								url: "../mine/login.html"
							});
						}

					}, false);

					chat.addEventListener("tap", function() {
						if(localStorage.getItem('user')) {
							mui.openWindow({
								id: "bookmanage/chat.html",
								url: "../bookmanage/chat.html"
								//								url: "../bookmanage/chat1.html"
							});
						} else {
							alert("请先登录！");
							mui.openWindow({
								id: "mine/login.html",
								url: "../mine/login.html"
							});
						}
					}, false);

				}
			</script>
	</body>

</html>